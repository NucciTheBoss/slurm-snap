#!/bin/sh -e
# Copyright 2024 Canonical Ltd.
# See LICENSE file for licensing information.

MUNGE_KEY=$(snapctl get munge.key)
MUNGE_NUM_THREADS=$(snapctl get munge.num-threads)
SLURM_CONF=$(snapctl get slurm.conf)
SLURMDBD_CONF=$(snapctl get slurmdbd.conf)
SLURMD_CONF_SERVER=$(snapctl get slurmd.conf-server)

# If munge.key set, update the munge key file using by the munge daemon.
# munge.key should be readable file system path outside the snap.
if [ -n "${MUNGE_KEY}" ]; then
  if [ -r "${MUNGE_KEY}" ]; then
    echo "[munge] Updating munge key with external key."
    install -m 0600 "${MUNGE_KEY}" "${SNAP_DATA}/etc/munge/munge.key"
    echo "[munge] munge.key updated. Restart slurm.munged for changes to take effect."
  else
    echo "[munge] munge.key ${MUNGE_KEY} is not readable."
    exit 1
  fi
fi

# If munge.num-threads set, update MUNGE_NUM_THREADS in default/slurm-snap.
if [ -n "${MUNGE_NUM_THREADS}" ]; then
  # Check that entered value is integer.
  if echo "${MUNGE_NUM_THREADS}" | grep -Eq "^[0-9]+?"; then
    echo "[munge] Updating number of threads for munged daemon."
    sed -i -E "s/^MUNGE_NUM_THREADS=[0-9]+\$/MUNGE_NUM_THREADS=${MUNGE_NUM_THREADS}/" \
      "${SNAP_DATA}/etc/default/slurm-snap"
    echo "[munge] Number of threads updated to ${MUNGE_NUM_THREADS}. " \
      "Restart slurm.munged for changes to take effect."
  else
    echo "[munge] Error: ${MUNGE_NUM_THREADS} is not a valid number of threads."
    exit 1
  fi
fi

# If slurm.conf set, update slurm.conf file inside the slurm snap.
if [ -n "${SLURM_CONF}" ]; then
  if [ -r "${SLURM_CONF}" ]; then
    echo "[slurm] Updating slurm.conf with external configuration file."
    install -m 0644 "${SLURM_CONF}" "${SNAP_DATA}/etc/slurm/slurm.conf"
    echo "[slurm] slurm.conf updated. Restart slurm.slurmctld, slurm.slurmd, slurm.slurmdbd, "\
      "and slurm.slurmrestd for changes to take effect."
  else
    echo "[slurm] slurm.conf ${SLURM_CONF} is not readable."
    exit 1
  fi
fi

# If slurmdbd.conf set, update slurmdbd.conf file inside the slurm snap.
if [ -n "${SLURMDBD_CONF}" ]; then
  if [ -r "${SLURMDBD_CONF}" ]; then
    echo "[slurmdbd] Updating slurmdbd.conf with external configuration file."
    install -m 0644 "${SLURMDBD_CONF}" "${SNAP_DATA}/etc/slurm/slurmdbd.conf"
    echo "[slurmdbd] slurmdbd.conf updated. Restart slurm.slurmdbd for changes to take effect."
  else
    echo "[slurmdbd] slurmdbd.conf ${SLURMDBD_CONF} is not readable."
    exit 1
  fi
fi

# If slurmd.conf-server set, update SLURMD_CONF_SERVER in default/slurm-snap.
if [ -n "${SLURMD_CONF_SERVER}" ]; then
  echo "[slurmd] Updating configuration server list."
  sed -i -E "s/^SLURMD_CONF_SERVER=.+\$/SLURMD_CONF_SERVER=${SLURMD_CONF_SERVER}/" \
    "${SNAP_DATA}/etc/default/slurm-snap"
  echo "[slurmd] Configure server updated to ${SLURMD_CONF_SERVER}. " \
    "Restart slurm.slurmd for changes to take effect."
fi
